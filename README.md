#==========================================================
#### ME Algorithm, 2023
#### Yan-Bin Chen (陳彥賓)  yanbin@stat.sinica.edu.tw; Chen-Hsiang Yeang (楊振翔)   chyeang@stat.sinica.edu.tw
#### Institute of Statistical Science, Academia Sinica, Taipei, Taiwan.
#### August, 2023 
#==========================================================
#
(a) File descriptions:
1. "phase2_generate_seedregions_package.m"

    Function: the Matlab program of selecting seed regions from the data. The default parameter values of running this code are provided in "MNIST_generate_seedregions_params.txt" and "CIFAR10_generate_seedregions_params.txt" for MNIST and CIFAR10 datasets, respectively.

    Inputs: embedded data, region labels, several free parameters, and thresholds. The thresholds are predefined to stop the selection of seed region candidates. Details for each parameter are described as follows.

       data: Image data represented as a matrix.  Rows are images and columns are flattened pixel positions of the images.

       augdata: Augmented image data generated by translating, rotating or flipping the original images.  It is a three-dimensional tensor with size n1xn2xn3, where n1 and n2 denote the number of images and pixels and n3 denotes the number of augmentations for each image.

       embeddata: The data matrix undergoing the fixed embedding operations.  Rows are images and columns are the markers of the embeddings.

       datamode: An indicator variable specifying two possible ways of selecting seed regions.  datamode=1: use the image data (argument data) to generate seed regions.

       datamode=2: use the embedded data (argument embeddata) to generate seed regions.

       regionneighborlabels: A vector denoting the region indices of images.  The number of components is the number of images.  regionneighborlabels(i) denotes the region index of image i.

       filter: An indicator variable specifying three possible ways to filter members of regions.  filter=0: do not apply a filter.  filter=1: use geometric information of the entire embedding space to filter images.  filter=2: use marker information to filter images.

       theta: The lower bound of the threshold values, represented as a quantile value of the distances, for constructing a neighborhood graph.

       theta2: The threshold of the ratio #(major branch cluster members whose mean distances to the minor branch cluster members are smaller than the mean distances to the major branch cluster).  If the ratio < thre2, then the minor branch cluster is located outside the major branch cluster.

       theta3: The threshold for excluding regions for selecting seed regions.  Exclude the regions whose center zones comprise <= theta3 fraction of members.

       sizethre: The threshold value on the sizes of majority and minority clusters of each branch point.  Consider the top-level branch point with cluster size >= sizethre.  Split the region members as core and periphery members in terms of the chosen branch point.

       topthre: The upper bound of the ranks of the embedded data values to be considered as high values.  For each marker, count the number of images possessing the values with <= topthre ranks.

       nimagesthre: The lower bound of the number of images with high values to be considered as informative markers.  Select the markers where the number of images within the top rank values >= nimagesthre.

       mthre: The threshold value of considering candidate markers.  If a marker's mean value over the lower subset of the images >= mthre, then discard this marker as a candidate.

       lwdthre and uppthre: Thresholds on the range of the mean values of the lower and upper image subsets for determining informative markers.  A marker is considered as an informative marker if the mean of the lower image subset <= lwdthre and the mean of the upper image subset >= uppthre.

       nmarkersthre: Discard a region if it consists of >= nmarkersthre informative markers.

       rankthre: The threshold on the rank values of the embedded data to be considered as high (or active) values.

       rankratiothre: The threshold on the fraction of entries whose ranks <= rankthre.  If this fraction < rankratiothre, then the marker is a valid candidate of informative markers.

       disparitythre: The threshold on the size ratio between two groups of images separated by the informative marker values.  The ratio >= 1 as we place the larger group size in the numerator.  If the ratio < disparitythre, then the two groups of images have similar sizes and we do not split them.

       overlapthre: The threshold of overlap ratios to determine whether two informative markers give consistent partitions to images.  For two markers, introduce two partitions, and each partition yields two subsets of images.  Count the ratios of possible overlap of these two partitions.  If the ratios < overlapthre, then the two markers do not yield consistent partitions.

       highthre: Threshold on the fraction of high-value entries.  Consider a marker as an informative marker of a region if the fraction of high-value entries (the ranks <= topthre) >= highthre.

       dthre: Threshold on the median distances over the marker rank values.  For each marker, extract the regions with high fractions of the marker and evaluate the their rank distance distributions.  Identify the informative markers where the median rank value distances <= dthre.

       sharedthre: Threshold on the fraction of shared region informative markers.  For each (region,neighboring region) pair, count the fraction of shared region informative markers among their union of region markers.  For each region, find the neighbor regions whose fractions of shared region informative markers >= sharedthre.  Consider these neighbor regions as valid neighbor regions.

       nnbsthre: The number of neighbor regions to be considered when filtering regions.

       nvalidnbsthre: Threshold value on the number of valid neighbor regions.  If less than nvalidnbsthre neighbors are valid, then the region is not considered. 

       rthre: Threshold on the size ratio of a larger to a smaller groups of images by applying a binary classification induced by two regions.  If the ratio <= rthre, then consider the two regions as the first two seed regions.

       regionpairDmode: An indicator of two possible ways to calculate average distances between regions.  regionpairDmode=0: use all members of regions to calculate the average distances.  regionpairDmode=1: use core members of regions to calculate the average distances.

       maxnseeds: The maximum number of seed regions included in the first pass of selecting seed regions.

       ratiothre: Threshold on the fraction of images which are assigned to an existing seed region before and to a newly added seed region after.  If the fraction <= ratiothre, then the newly added seed region resembles an existing seed region.

       foldthre: Threshold on the fold change of the fraction of images which are assigned to an existing seed region before and to a newly added seed region after.

       nclassesthre: If the number of existing seed regions <= nclassesthre, then only use ratiothre to determine whether a newly added seed region is distinct.  Otherwise use both ratiothre and foldthre.

       diffratiothre: Threshold on the ratio of the fraction of differently assigned images.  Only choose the seed regions whose ratios >= diffratiothre.


  
    Outputs: contain the following variables:

       nseeds: Number of seed regions.

       seedinds: The indices of seed regions.

       bilabels: The region memberships of all images.  The number of rows is the number of images, and the number of columns is 2.  Column 1 reports the region indices of the images.  Column 2 reports binary indicators of whether each image is a core member of the region.

       regionpairD: The pairwise distance matrix of regions.  Each entry denotes the mean distance between members of two regions.


2. "phase3_three_predicted_results.ipynb"

   Function: the Python code for generating three CNN predicted results: "original," "combinational," and "removal," for the evaluation of four scores.

   Inputs: following files specified by the path are the input data. The input files presented here are provided as examples for instructional guidance. Users can input their own data based on their applications.
   
       PATH1='./Data/NCT_VGG16_K200_seedinds_version2_valid.txt'  -->  the seed regions ("seedinds") given by the phase 2. 
  
       PATH2='./Data/NCT_VGG16_K200_bilabels_version2.txt'  --> the data file to indicate which labels ("bilabels") are effective given by phase 2.
  
       PATH3='./Data/VGG16_CRC_100K_tSNE_Spec.csv'  --> the data file to specify the entire region indices.
  
       PATH4='./Data/NCT_VGG16_K200_neighborregions_version2_valid.txt'  --> to specify the neighboring regions of seed regions.
  
       PATH5='./Data/20230106_NCT_Vgg16_test_label.pickle'  --> the embedded data.

       TRIALS: the number of trials for the CNN. Usually, set to 1.
   
       timestr: the prompt for the output file.

  
    Outputs: output three CNN predicted files for the four scores evaluation, as follows:
   
       results_of_original.mat  --> the predicted results of original CNN.

       results_of_combination.mat  --> the predicted results of combinatorial CNN. 

       results_of_removal.mat  --> the predicted results of removal CNN.


3. "phase4_merge_seedregions_package.m"

    Function: the Matlab program of merging seed regions according to three combinatorial classification outcomes (.mat files). The default parameter values of running this code are provided in "MNIST_merge_seedregions_params.txt" and "CIFAR10_merge_seedregions_params.txt" for MNIST and CIFAR10 datasets, respectively.

    Inputs: information about regions and seed regions, prediction outcomes, and thresholds. Details for each parameter are described as follows.

       nseeds: Number of seed regions.

       seedinds: Seed region indices.

       result_for_original: The CNN classification outcomes of all images as a matrix.  The number of classes is the number of seed regions.  The number of rows is the number of images.  The number of columns is the number of trials for CNN classifications.

       prob_for_original: The normalized activation outputs of CNN classifications of all images as a 3D tensor with n1xn2xn3 dimensions.  n1, n2, n3 denote the number of trials for CNN predictions, number of images, number of seed regions.

       combination_pairs: All pairs of seed region indices as a matrix.  The number of rows is the number of pairs.  The number of columns is 2.

       result_for_merge: The CNN prediction outcomes for combining each pair of seed regions in the training classes.  The number of classes is the number of seed regions minus 1.  The number of rows is the number of seed region pairs.  The number of columns is the number of images.

       result_for_removal: The CNN prediction outcomes for removing each seed region from the training classes.  The number of classes is the number of seed regions minus 1.  The number of rows is the number of seed regions.  The number of columns is the number of images.

       data: Image data represented as a matrix.  Rows are images and columns are flattened pixel positions of the images.

       regionneighborlabels: A vector denoting the region indices of images.  The number of components is the number of images.  regionneighborlabels(i) denotes the region index of image i.

       regiontraininglabels: A vector denoting the region indices of images as core members of regions.  The number of components is the number of images.  regiontraininglabels(i) denotes the region index of image i.  regiontraininglabels(i)=0 if image i is a periphery member of its region.

       usemarker: An indicator for whether using marker information to identify singleton classes.

       nprednumthre: Threshold on the number of images assigned to a seed region according to CNN prediction.  If the number is below nprednumthre, then this seed region is discarded.

       pvalthre: Threshold on the Wilcoxan test p-values for leakage scores.  A p-value is significant if it is below pvalthre.

       ntoprankthre: Threshold on the ranks of the scores.  A score is on the top rank if the rank <= ntoprankthre.

       quantilethre: Threshold on the quantile of ranks of the scores.  A score is on the top rank if the quantile of the rank <= quantilethre.

       importthre: An indicator of whether determining the thresholds on the three types of scores from their distributions (importthre=0) or importing the thresholds (importthre=1).

       replacementratiothre: Threshold on the replacement scores.

       localranksumpvalthre: Threshold on the leakage scores.

       cocontributionthre: Threshold on the co-contribution scores.

       reducedrankscorethre: Threshold on the reduced rank scores.

       confusionratiothre: Threshold on the confusion ratios between two classes.  A link is added if the confusion ratio is above the threshold.

       sizethre: Threshold on the size of the components of seed regions generated by spectral clustering.  All components have size <= sizethre.

       jumpfoldthre: Threshold on the ratio of minimum inter subcluster distance and maximum intra subcluster distance.  If the ratio >= jumpfoldthre, then consider the subcluster as an outlier.

       smallclustersizethre: Threshold on the size of a cluster to be considered as an outlier.  A cluster is considered an outlier when the size <= smallclustersizethre.

       gapfoldthre: Threshold on the ratio between the largest gap and the second largest gap in the first dimension of spectral clustering.  If the ratio >= gapfoldthre, then split the data points along the largest gap.

       smallratiothre: Threshold on the ratio of val1/val2.  val1 is the minimum difference between data points at positive and negative sides of first dimension.  val2 is the maximum difference of data points of the first dimension.  If val1/val2 <= smallratiothre, then split the data points by the two sides of the largest gap.

       pdiffthre: Threshold on the minimum pdiff score by comparing the marker values of all pairs of seed regions.  If the minimum pdiff score >= pdiffthre, then consider a marker to be valid.

       pdiffthre2: Threshold on the minimum pdiff score by comparing the marker values of pairs of selected seed regions.  If the minimum pdiff score >= pdiffthre, then consider a marker to be valid.

       medvalthre: Threshold on the median values of each marker in each marker.  A marker is considered when the median value >= medvalthre.

       ninformativemarkersthre: Threshold on the number of informative markers distinguishing one seed region from other seed regions.  If the number of informative markers >= ninformativemarkersthre, then assign the seed regions as singletons.

       ninformativemarkersthre2: Similar to ninformativemarkersthre, but use a slightly more stringent criterion to determine informative markers.  When determining informative markers, only use the entries within 95% quantile.

       cntdiffthre: Threshold on the difference of counts of informative markers.  If the difference between the first and second largest counts >= cntdiffthre, then mark the seed region with the highest count as a singleton.


    Outputs: contain the following variables:
   
       nmergeoutcomes: Number of merged seed regions outcomes.

       mergedclasslabels: Merged seed regions outcomes as a matrix.  It has nmergeoutcomes rows and nseeds columns.  Each column denotes one merged seed regions outcomes.  The entries are the indices of the merged seed region groups.  Seed regions which are merged together share the same indices.


4. "phase5_merge_then_expand.ipynb"

    Function: the Python code for merging and expanding seed regions.
  
    Inputs: the following files specified by the path are the input data. The input files presented here are provided as examples for instructional guidance. Users can input their own data based on their applications. 

       PATH3='./Data/VGG16_CRC_100K_tSNE_Spec.csv'--> the data file to specify the entire region index.
  
       PATH5='./Data/20230106_NCT_Vgg16_test_label.pickle' --> the true labels for the accuracy evaluation.
  
       PATH6='./Data/NCT_VGG16_K200_mergedseedclasslabels_version2.txt' --> the merged results ("nmergeoutcomes" and "mergedclasslabels") given by the phase 4.
  
       PATH7='./Data/region_for_phaseIV.pickle'  --> the initial conditions.

       NUM_CASE: to indicate how many cases in the merged seed regions outcomes.

       DATASET: to specify the datasets.
   
       INTE_bool: the switch to specify the intergration netwrok mode or single network mode.
   
       ITE_FROM: the start point of the loop. This is for the special case or debugging.
  
    Outputs: output the accuracy tables.

5. "CNN_Modules_1D.py"

    Function: function call for the 1D CNN.

6. "CNN_Modules.py"

    Function: function call for the 2D CNN.
   
7. "functions.zip"

    Function: This is a zip file which includes accessory functions (.m files) and parameter values (.txt files) for "phase2_generate_seedregions_package.m" and "phase4_merge_seedregions_package.m". Please unzip this zip file into the same directory of "phase2_generate_seedregions_package.m" and "phase4_merge_seedregions_package.m".

#
(b) Execution procedures:
1. Run "phase2_generate_seedregions_package.m" to generate the seed regions.
2. Run "phase3_three_predicted_results.ipynb". It outputs several immediate pickle files and three mat files. The users may ignore pickle files. Three mat files are the data prepared for the next phase 4. The three mat files are "results_of_original.mat", "results_of_combination.mat" and "results_of_removal.mat".
3. Run "phase4_merge_seedregions_package.m" to get merging tables.
4. Run "phase5_merge_then_expand.ipynb" to obtain the clustering results. It outputs "accu_history.csv" to evaluate the accuracy as well.
